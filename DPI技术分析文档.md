# DPI (深度包检测) 技术分析文档

## 1. DPI 检测范围

| 流量类型 | DPI 检测 | 说明 |
|---------|---------|------|
| 境内 → 境内 | ❌ 不检测 | 中国大陆内部流量，无审查 |
| 境内 → 境外 | ✅ 检测 | 出境流量，受到严格审查 |

**结论：DPI 只审查中国出境流量**

---

## 2. DPI 封锁策略

### 2.1 IP 封锁

**方式：** 直接封锁目标服务器 IP 地址

**示例：**
| 网站 | 被封锁的 IP |
|------|------------|
| GitHub | 20.205.243.166 |
| Google | 142.250.x.x |

**特征：**
- TCP 连接超时
- 握手失败
- 无法获取证书

### 2.2 SNI 封锁

**方式：** 检测 TLS ClientHello 中的 SNI (Server Name Indication) 字段

**原理：**
```
ClientHello (明文)
├── TLS 版本
├── 加密套件列表
├── SNI: google.com  ← DPI 检测这个
├── ...
```

**示例：**
| 域名 | SNI 关键字 | 结果 |
|------|-----------|------|
| pornhub.com | pornhub.com | ❌ 阻断 |
| telegram.org | telegram.org | ❌ 阻断 |
| youtube.com | youtube.com | ❌ 阻断 |

### 2.3 TLS 指纹检测

**方式：** 分析 TLS ClientHello 的特征（加密套件顺序、扩展列表等）

**作用：** 识别客户端类型，阻断非标准客户端

---

## 3. ECH (Encrypted Client Hello)

### 3.1 ECH 原理

ECH 是 TLS 1.3 的扩展，用于加密 SNI：

```
原始 ClientHello:
├── SNI: google.com
└── ...

ECH 加密后:
├── SNI: (加密成 ech)
├── ECH 扩展
└── ...
```

### 3.2 ECH 的局限性

1. **ECH 扩展可被检测**：DPI 可以看到 ClientHello 中有 ECH 扩展
2. **IP 封锁仍然有效**：即使 SNI 加密，IP 封锁不受影响
3. **TLS 指纹**：ECH 不能解决指纹检测问题
4. **服务器支持有限**：并非所有网站都支持 ECH

### 3.3 结论

**ECH 不是万能解决方案**，DPI 可以通过以下方式应对：
- 检测 ECH 扩展的存在
- 直接封锁目标 IP
- 分析 TLS 指纹

---

## 4. 绕过方案对比

### 4.1 透传方案（不可靠）

```
浏览器 → 代理 → 边缘节点 → DPI → 目标服务器
                   ↑
            境内 IP（无 DPI）
                     ↑
              SNI=真实域名（没变！）
```

**问题：**
- SNI 仍然是真实域名
- 跨境流量经过 DPI 时会被检测
- 只有境内→境内的边缘节点才可能绕过

**可用场景：**
- 网站有中国境内边缘节点（如 Google 8.137.x.x）
- 访问时流量是境内→境内

### 4.2 中间人方案（可靠）

```
浏览器 → 代理(证书) → DPI → 上游服务器
    ↓              ↑
 真实SNI      SNI=无害域名(g.cn)
```

**原理：**
1. 浏览器与代理建立 TLS（使用 CA 证书）
2. 代理解密流量，修改 SNI
3. 代理与上游建立 TLS（SNI 改为无害域名）
4. DPI 看到的是无害 SNI（g.cn）

**优势：**
- SNI 可修改为无害域名
- 不依赖境内边缘节点
- 更可靠

---

## 5. 网站分类与解决方案

### 5.1 可透传的网站

**特征：** 网站有中国境内 CDN 边缘节点（仅 Google 系）

| 网站 | 边缘节点 IP | 说明 |
|------|----------|------|
| YouTube | 8.137.102.117 | 阿里云境内节点 |
| gstatic.com | 8.137.102.117 | Google 静态资源 |
| gemini.google.com | 47.102.115.14 | Google AI |

**注意：** 透传适用范围极窄，仅 Google 系有境内边缘节点的网站可用。

### 5.2 必须中间人的网站

**特征：** 无境内边缘节点，或 SNI 验证严格

| 网站 | 原因 |
|------|------|
| Pornhub | 无境内节点，SNI 检测 |
| Telegram | 无境内节点，SNI 检测 |
| GitHub | IP 被封锁 |
| Wikipedia | 无境内节点 |

---

## 6. SNIBypassGUI 工作原理

### 6.1 架构

```
浏览器 ─HTTPS(SNI:目标域名)─→ Nginx(CA证书) ─HTTPS(SNI:g.cn)─→ 边缘节点/目标
```

### 6.2 关键配置

```nginx
# 上游配置
upstream google-com {
    server 8.137.102.117:443;
}

# 服务配置
server {
    server_name google.com;
    
    # 证书（浏览器信任）
    ssl_certificate ca/SNIBypassCrt.crt;
    ssl_certificate_key ca/SNIBypassKey.key;
    
    # 修改 SNI
    proxy_ssl_name g.cn;
    
    # 转发
    proxy_pass https://google-com/;
}
```

### 6.3 工作流程

1. 浏览器访问 google.com
2. Nginx 使用 CA 证书建立 TLS（浏览器信任）
3. Nginx 连接到上游，修改 SNI 为 g.cn
4. DPI 看到 SNI=g.cn，放行
5. 上游返回正确内容

---

## 7. 开发建议

### 7.1 方案选择

| 方案 | 可靠性 | 复杂度 | 适用场景 |
|------|--------|--------|---------|
| 透传 | 低 | 简单 | 极少数有境内边缘节点的网站 |
| 中间人 | 高 | 复杂 | 大多数网站 |

### 7.2 建议架构

1. **默认使用中间人方案**
2. 透传作为备用（仅针对已知可用的境内边缘节点）
3. 支持 CA 证书导入
4. 支持 SNI 自定义
5. **引入 utls 模拟浏览器 TLS 指纹**，应对 TLS 指纹检测

### 7.3 边缘节点维护

需要维护一份可用的境内边缘节点列表：
- 定期检测连通性
- 自动剔除不可用节点
- 支持手动添加

---

## 8. 总结

1. **DPI 只检测出境流量**
2. **境内→境内流量无检测**，可利用边缘节点透传
3. **跨境流量 SNI 被检测**，需要中间人方案
4. **TLS 指纹会被检测**，需要用 utls 模拟浏览器指纹
5. **ECH 不能完全解决 SNI 泄露问题**
6. **中间人方案是目前最可靠的方案**
