# SNIBypassGUI 上位替代 - 规划文档

## 1. 问题分析与解决方案

### 1.1 DPI (深度包检测) 特性

DPI 是运营商或防火墙用于检测网络流量的技术，主要检测点：

| 检测维度 | 说明 | 示例 |
|----------|------|------|
| IP 地址 | 直接封锁目标服务器 IP | 封锁 142.250.x.x (Google IP) |
| SNI (Server Name Indication) | TLS 握手中的域名信息 | 检测 ClientHello 中的域名 |
| TLS 指纹 | TLS ClientHello 的特征 | 透传方案不涉及此问题 |


**DPI 封锁层次：**

```
1. IP 封锁：直接封锁目标服务器 IP
   └── 解决方案：使用边缘节点（云服务商 CDN）

2. SNI 封锁：检测 TLS 握手中的域名
   └── 解决方案：境内边缘节点不触发跨境 DPI 检测

3. TLS 指纹封锁：检测 TLS ClientHello 特征
   └── 解决方案：透传方案不涉及，无需处理

4. 流量分析：检测流量模式特征
   └── 解决方案：保持简单透传，避免额外特征
```

### 1.2 SNIBypassGUI 原方案

**架构：**

```
浏览器 → [Nginx + CA证书] → 边缘节点 → 目标网站
              ↓
        SSL 中间人
        (证书替换)
```

**技术实现：**

| 组件 | 作用 |
|------|------|
| Nginx | HTTP/HTTPS 代理服务器 |
| CA 证书 | 浏览器信任，用于证书伪造 |
| 边缘节点 | 部署在中国境内的云服务商 CDN 节点（如阿里云、百度）|
| SNI 修改 | 将域名改为无害域名（g.cn、pornhub-com 等）|

**存在的问题：**

- 需要安装 CA 证书（每次都需要信任证书）
- Nginx 配置复杂，难以维护
- SSL 中间人增加复杂度
- 依赖证书替换机制

### 1.3 我们的解决方案

**核心思路：**

```
浏览器 ←HTTP CONNECT/TUN→ 我们的代理 ←TCP透传→ 边缘节点 ←TLS→ Google/YouTube
```

**关键改进：**

| 改进点 | SNIBypassGUI | 我们的方案 |
|--------|--------------|------------|
| 证书 | 需要 CA 证书安装 | 无需证书（透传模式）|
| TLS 处理 | SSL 中间人 | 直连透传 |
| SNI | 修改为无害域名 | 境内边缘节点不触发 DPI |
| 复杂度 | Nginx + 证书配置 | 纯 Go 代码 |
| UDP 支持 | 不支持 | TUN 模式支持 |

**两种运行模式：**

| 模式 | 协议支持 | 证书 | SNI 修改 | 复杂度 |
|------|----------|------|----------|--------|
| HTTP CONNECT | TCP | 无需 | ❌ | 低 |
| TUN 虚拟网卡 | TCP + UDP | 无需 | ❌ | 中 |

**我们的优势：**

1. **免证书**：浏览器和上游直接 TLS 握手，无需 CA 证书
2. **简单透传**：代理只做 TCP 透传，流量特征极少
3. **境内节点**：使用边缘节点绕过跨境 DPI 检测
4. **UDP 支持**：TUN 模式可接管所有流量
5. **易于维护**：纯 Go 代码，无复杂依赖

### 1.4 双轨方案设计

本软件支持两种运行模式：**透传模式**（默认）和**中间人模式**（备用）。

#### 模式一：透传模式（默认）

```
浏览器 ←HTTP CONNECT/TUN→ 代理 ←TCP透传→ 边缘节点 ←TLS→ Google/YouTube
```

| 特性 | 说明 |
|------|------|
| SNI | 真实域名（如 www.google.com） |
| 证书 | 无需 CA 证书 |
| UTLS | 不需要 |
| 复杂度 | 低 |

**优点：**
- 无需安装 CA 证书
- 代理只做 TCP 透传，流量特征极少
- 简单可靠

**缺点：**
- SNI 明文发送，依赖"DPI 不审查境内 SNI"假设
- 如果 DPI 升级审查境内 SNI，方案可能失效

#### 模式二：中间人模式（备用）

```
浏览器 ←TLS1→ 代理(解密) ←TLS2(修改SNI+UTLS)→ 边缘节点 ←TLS3→ Google
         (CA证书)        ↓
                    修改 SNI + UTLS 指纹
```

| 特性 | 说明 |
|------|------|
| SNI | 可修改为无害域名 |
| 证书 | 需要 CA 证书 |
| UTLS | 需要，伪装浏览器指纹 |
| 复杂度 | 高 |

**优点：**
- 可修改 SNI，不暴露真实目标域名
- 更安全，DPI 无法识别目标

**缺点：**
- 需要安装 CA 证书
- 复杂度高，需要处理 TLS 握手
- UTLS 需要定期更新指纹库

#### 模式选择

| 使用场景 | 推荐模式 |
|----------|----------|
| 首次使用，不想安装证书 | 透传模式 |
| 需要更高的隐蔽性 | 中间人模式 |
| DPI 升级后透传失效 | 中间人模式 |

用户可通过 GUI 界面手动切换两种模式。

### 1.5 风险提示

**潜在风险：**

本方案依赖一个关键假设：**DPI 只审查跨境流量**。如果未来 DPI 系统升级，开始识别境内流量的 SNI，本方案可能失效。

**应对策略：**

| 方案 | 说明 | 状态 |
|------|------|------|
| 透传模式（默认）| 依赖境内节点不触发 DPI | ✅ 验证可行 |
| 中间人模式（备用）| 修改 SNI + UTLS + CA 证书 | ⚠️ 复杂，备用方案 |

### 1.6 核心原理验证

实验已验证以下方案可行：

- 边缘节点 (8.137.102.117, 180.163.150.34 等) 可正常连接 Google/YouTube
- HTTP CONNECT + TCP 透传模式浏览器可正常访问
- 上游返回正确的 TLS 证书，无需证书替换

---

## 2. 技术选型

### 2.1 核心语言: Go

**选择理由：**
- 性能接近C，但开发效率高
- goroutine 并发模型优秀，适合代理场景
- 内存管理自动化
- 静态编译，单文件分发
- 丰富的标准库

### 2.2 性能目标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 并发连接 | 10000+ | 支持大量并发连接 |
| 吞吐量 | 500Mbps+ | 接近 Nginx 水平 |
| 内存占用 | < 100MB | 空闲状态 |
| 延迟 | < 5ms | 代理转发延迟 |

### 2.3 性能优化策略

- I/O 模型：epoll (Linux) / kqueue (macOS) - Go netpoll 已内置
- 连接池：复用上游 TCP 连接，减少握手开销
- 内存池：减少频繁 GC，使用 sync.Pool
- 零拷贝：减少数据拷贝
- 缓冲策略：合理设置读写缓冲区大小

---

## 3. 系统架构

| 层级 | 模块 |
|------|------|
| 配置层 | 配置文件加载、命令行参数、热重载支持 |
| 核心层 | 代理服务器、规则匹配引擎、IP 池管理、连接管理 |
| 协议层 | HTTP CONNECT 处理、SOCKS5 处理 |
| 规则层 | 域名规则、IP 规则 |
| 数据层 | 静态配置、动态更新 |
| 日志层 | 文件日志、控制台输出 |

---

## 4. 功能规划

### 4.1 核心功能

| 功能 | 优先级 | 说明 |
|------|--------|------|
| HTTP CONNECT 代理 | P0 | 基础功能，TCP 透传 |
| SOCKS5 代理 | P1 | 兼容性支持 |
| 域名规则匹配 | P0 | 支持通配符、前缀匹配 |
| IP 选择策略 | P0 | 轮询/最少连接/延迟最优 |
| 规则热重载 | P2 | 无需重启更新规则 |

### 4.2 负载均衡策略

| 策略 | 说明 | 适用场景 |
|------|------|----------|
| 轮询 | 依次选择每个 IP | IP 质量相近 |
| 最少连接 | 选择活跃连接最少的 IP | 负载不均 |
| 延迟探测 | 定期探测延迟，选择最优 | 网络波动大 |
| 失败切换 | IP 失败自动切换 | 可靠性要求高 |

**推荐策略**：延迟探测 + 失败切换组合

### 4.3 隐蔽性设计

| 技术 | 说明 | 评估 |
|------|------|------|

| TLS 指纹模拟 | 透传方案不涉及此问题 | - |
| HTTP 指纹 | 透传方案不涉及此问题 | - |
| 连接复用 | 复用连接减少特征 | ✅ 可选 |

### 4.4 原项目 SNI 策略分析

| 原始域名 | SNI 修改为 | 目的 |
|----------|------------|------|
| youtube.com | g.cn | 伪装成国内无害域名 |
| google.com | g.cn | 伪装成国内无害域名 |
| pornhub.com | pornhub-com | 保持对应关系 |
| pixiv.net | pixivision.net | 伪装成相关无害域名 |

### 4.5 技术路线总结

```
浏览器 ←HTTP CONNECT→ 我们的代理 ←TCP透传→ 边缘节点 ←TLS→ Google/YouTube
```

**核心优势：**
- 代理只是透传，流量特征极少
- 只连接可信的边缘节点
- 使用边缘节点（云服务商 CDN）绕过跨境 DPI 检测


### 4.6 可选功能

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 流量统计 | P3 | 带宽、连接数统计 |
| 黑白名单 | P2 | 灵活的访问控制 |
| ACL 控制 | P2 | 基于 IP/域名的访问控制 |

---

## 5. 模块设计

### 5.1 配置模块

- 配置文件加载 (YAML/JSON)
- 命令行参数解析
- 热重载支持

### 5.2 代理模块

- HTTP CONNECT 服务器
- SOCKS5 服务器
- TCP 透传核心

### 5.3 规则引擎

- 域名精确匹配
- 前缀匹配 (*.google.com)
- 泛域名匹配

### 5.4 IP 池模块

- 静态 IP 配置
- 动态更新 (远程拉取)
- IP 状态管理

### 5.5 连接池

- 上游连接复用
- 连接生命周期管理

### 5.6 日志模块

- 文件日志
- 控制台输出
- 日志级别控制

---

## 6. 配置文件示例

```yaml
server:
  http_port: 8080
  socks5_port: 1080

rules:
  - domain: "google.com"
    upstream:
      hosts:
        - ip: "8.137.102.117"
          port: 443
        - ip: "180.163.150.34"
          port: 443
      strategy: "round_robin"  # 轮询
      
  - domain: "youtube.com"
    upstream:
      hosts:
        - ip: "8.137.102.117"
          port: 443
      strategy: "latency_based"

log:
  level: "info"
  file: "./logs/proxy.log"
```

---

## 7. 目录结构

```
sni-proxy/
├── main.go                 # 入口
├── go.mod                  # 依赖
├── config/                 # 配置加载
├── proxy/                  # 代理服务器
├── rule/                   # 规则匹配
├── pool/                   # 连接池、内存池
├── upstream/               # 上游管理
├── log/                   # 日志
└── config.yaml            # 配置文件
```

---

## 8. 开发计划

### Phase 1: 基础框架（关键验证）
- 项目初始化
- 配置加载
- HTTP CONNECT 代理
- TCP 透传
- **核心验证**：边缘节点 + 纯透传是否真的能绕过 DPI

### Phase 2: 核心功能
- 规则匹配引擎
- 多 IP 轮询
- **延迟探测 + 健康检查**（关键）
- SOCKS5 支持

### Phase 3: TUN 模式 + 优化
- TUN 虚拟网卡模式（支持 UDP）
- 连接池（可提前）
- 内存池（sync.Pool）
- 性能测试（wrk/hey 基线）

### Phase 4: 扩展
- 规则热重载
- 流量统计
- 系统代理支持（PAC 自动脚本）
- SNI 修改备用方案（双重 TLS）

### Phase 5: GUI 设计

#### 5.1 技术选型

| 技术 | 选型 | 理由 |
|------|------|------|
| 框架 | Tauri | 轻量、原生体验、Go 后端 |
| 前端 | React 18 + TypeScript | 生态丰富 |
| 样式 | Tailwind CSS + Shadcn UI | 现代化、原子化设计 |
| 图表 | Recharts | React 生态 |
| 状态 | Zustand | 轻量、简单 |

#### 5.2 界面设计规范

**整体布局：**
- 左侧：侧边栏（固定宽度，顶部预留拖拽区域）
- 右侧：主面板（自适应宽度）
- 整体背景：微灰色 (#f5f7fa)
- 圆角：所有卡片 16px，按钮 12px

**窗口特性：**
- 无边框模式，侧边栏和主面板顶部预留 `data-tauri-drag-region` 拖拽区域
- 响应式栅格布局：主面板 `grid-cols-2`，窗口宽度 < 800px 时自动切换为单列

**Shadcn UI 风格：**
- 参考 Shadcn UI 实现 Switch、Card 组件
- 统一的原子化设计感
- 细腻的 hover、active、disabled 状态
- 颜色系统使用 CSS 变量

#### 5.3 界面组件规划

**侧边栏：**
- 垂直图标菜单（首页、设置、日志、关于）
- 当前选中项高亮（背景变深 + 图标变色）
- 底部显示实时网速：上行 ↑ / 下行 ↓，等宽数字

**主面板 - 两列布局：**

| 卡片位置 | 标题 | 内容 |
|----------|------|------|
| 左上 | 边缘节点规则 | 来源、更新时间、节点数量、刷新按钮、状态 |
| 右上 | 连接统计 | 活跃连接数、运行时长、累计流量 |
| 左下 | 设置 | 系统代理开关、TUN 模式开关、端口配置 |
| 右下 | 运行模式 | 透传模式 / 中间人模式（互斥选择） |
| 底部 | 实时流量 | Recharts 折线图，可切换时间范围 |

**模式说明：**
- 透传模式（默认）：无需证书，真实 SNI
- 中间人模式：需要 CA 证书，可修改 SNI

#### 5.4 状态管理（Zustand）

```
- 当前模式（透传/中间人）
- 系统代理状态
- TUN 模式状态
- 规则信息（来源、更新时间、节点数量）
- 连接统计（活跃连接、运行时长、累计流量）
- 流量统计数据
```

#### 5.5 视觉细节要求

| 项目 | 要求 |
|------|------|
| 卡片背景 | 纯白 |
| 间距 | 卡片之间 24px |
| 图标 | Lucide React |
| 文字层级 | 标题 18px 粗体，正文 14px，辅助文字 12px 浅灰 |
| 开关 | Switch 组件，开蓝色，关灰色 |
| 悬停 | 卡片轻微上浮 + 阴影加深 |
| 过渡 | 所有交互 0.2s ease |

---

## 9. 关键技术点

### 9.1 TCP 透传

浏览器和上游服务器直接 TLS 握手，代理只负责透传数据，无额外处理，流量特征极少。

### 9.2 规则匹配

支持精确匹配、通配符匹配、泛域名匹配多种模式。

### 9.3 性能与特征

透传方案性能开销极低，瓶颈主要是网络带宽而非 CPU。优化手段包括使用 sync.Pool 复用缓冲区、合理设置缓冲区大小（32KB-64KB）、以及连接池复用。

透传本身不产生任何指纹特征，流量特征完全取决于浏览器/应用本身。

---

## 10. 总结

本方案采用 **Go 语言** + **HTTP CONNECT + TCP 透传** 技术路线：

1. **免证书**：浏览器和上游直连 TLS，无需 CA 证书
2. **高性能**：使用 Go 的 goroutine + epoll，性能接近 Nginx
3. **零指纹**：透传不产生额外特征，流量特征取决于浏览器
4. **模块化**：配置、代理、规则、连接池分离，易于维护

核心原理已通过实验验证可行，可直接进入开发阶段。
